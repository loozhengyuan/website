---
layout: post
title: Masked secrets in kubectl diff
tags:
  - kubernetes
  - kubectl
---

_TL;DR: Sensitive values in `Secret` objects will be masked when using `kubectl diff` from Kubernetes 1.22 onwards._

In my workplace, we use [`kustomize`](https://kustomize.io) and `kubectl apply` extensively to manage deployments to our [Kubernetes](https://kubernetes.io) cluster.

To ensure that we understand what changes are being applied, we use `kubectl diff` to preview these changes before triggering a deployment run to push these changes into production environment.

## Leaky diffs

Some time around Feb 2020, I realised that `kubectl diff` leaks sensitive values in [`Secret`](https://kubernetes.io/docs/concepts/configuration/secret/) objects. Since the command is ran as part of a CI/CD workflow, the leaky output of `kubectl diff` is displayed publicly. Even though the logs from our CI runs were not public _per se_, leaking these sensitive values in plaintext is just a security no-no.

For example, running `kubectl diff` on a `Secret` object with an updated `password` key will result in the following output:

```diff
 apiVersion: v1
 data:
-  password: c2VjcmV0
+  password: MTIzCg==
   username: YmFyCg==
 kind: Secret
 metadata:
```

Even though these values were base64-encoded, it did not make them any safer for use since any malicious actor could simply decode them.

As a temporary workaround, we decided to use `kubectl apply --server-dry-run` instead but this is clearly not a good solution because it is difficult to ascertain how the PR changes a Kubernetes object.

## Implementing a fix

As a frequent user of [GitHub Actions](https://github.com/features/actions), I was inspired by how secret values were automatically masked in the workflow logs. I am not entirely sure how they implemented this but it seems that it was a simple search/replace of the secret values on the log output before they are shown on the screen.

In the case of `kubectl diff`, it was a little more tricky because it works by creating two diff versions and then sending it to [`diff(1)`](https://man7.org/linux/man-pages/man1/diff.1.html). If we mask any secrets as-is, then the changes cannot be picked up by any differs.

The eventual solution was to perform comparisons for sensitive values first and masking them before sending it to a differ. If there are no changes between two values, they are masked with `***`. If there are changes, then a `(before)`/`(after)` suffix will be added to the mask so that the differ program will be able to show the difference.

With this change, running `kubectl diff` on a `Secret` object with an updated `password` key will now shown as: 

```diff
 apiVersion: v1
 data:
-  password: '*** (before)'
+  password: '*** (after)'
   username: '***'
 kind: Secret
 metadata:
```

The diff output generated by `kubectl diff` no longer exposes the sensitive values in `Secret` objects and will thus be safe for use in CI/CD pipelines.

## Feature availability

As of writing, PR [#96084](https://github.com/kubernetes/kubernetes/pull/96084) has been merged into the main branch of the [Kubernetes repository](https://github.com/kubernetes/kubernetes), and is expected to be available from Kubernetes 1.22.
